(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=e(s);fetch(s.href,i)}})();var C=function(d,t,e,n){function s(i){return i instanceof e?i:new e(function(o){o(i)})}return new(e||(e=Promise))(function(i,o){function c(r){try{a(n.next(r))}catch(u){o(u)}}function l(r){try{a(n.throw(r))}catch(u){o(u)}}function a(r){r.done?i(r.value):s(r.value).then(c,l)}a((n=n.apply(d,t||[])).next())})};class g{constructor(){this.apiUrl="https://randomuser.me/api/"}getUser(){return C(this,void 0,void 0,function*(){try{const t=yield fetch(this.apiUrl);if(!t.ok)throw new Error(`Ошибка: ${t.status}`);return(yield t.json()).results[0]}catch(t){console.log("Ошибка при получении пользователя:",t)}})}}const w=new g;w.getUser().then(d=>{console.log(`Имя: ${d.name.first} ${d.name.last}`)});class S{constructor(){this.counterElement=document.getElementById("comment-counter"),this.count=0,this.loadCount()}loadCount(){const t=JSON.parse(localStorage.getItem("comments")||"[]");this.count=t.length,this.updateCounter()}increment(){this.count++,this.updateCounter()}updateCounter(){this.counterElement.textContent=`${this.count}`}}var x=function(d,t,e,n){function s(i){return i instanceof e?i:new e(function(o){o(i)})}return new(e||(e=Promise))(function(i,o){function c(r){try{a(n.next(r))}catch(u){o(u)}}function l(r){try{a(n.throw(r))}catch(u){o(u)}}function a(r){r.done?i(r.value):s(r.value).then(c,l)}a((n=n.apply(d,t||[])).next())})};class I{constructor(t,e){this.commentCounter=t,this.commentElement=e}addElem(t,e,n,s){return x(this,void 0,void 0,function*(){if(!t.value.trim()){alert("Комментарий не может быть пустым!");return}const i=this.commentElement.createComment(t.value,n);e.appendChild(i),t.value="",this.commentCounter.increment(),yield s()})}}var E=function(d,t,e,n){function s(i){return i instanceof e?i:new e(function(o){o(i)})}return new(e||(e=Promise))(function(i,o){function c(r){try{a(n.next(r))}catch(u){o(u)}}function l(r){try{a(n.throw(r))}catch(u){o(u)}}function a(r){r.done?i(r.value):s(r.value).then(c,l)}a((n=n.apply(d,t||[])).next())})};class L{constructor(t,e){this.commentCounter=t,this.commentElement=e,console.log("AddReply создан, commentCounter:",this.commentCounter)}replyComment(t,e,n,s){return E(this,void 0,void 0,function*(){if(!e.trim()){alert("Ответ не может быть пустым!");return}const i=t.dataset.commentId,o=this.commentElement.createComment(e,s,n,!0,void 0,i);let c=t.querySelector(".repliesContainer");c||(c=document.createElement("div"),c.classList.add("repliesContainer"),t.appendChild(c)),c.appendChild(o),console.log("Перед увеличением счетчика:",this.commentCounter),this.commentCounter.increment()})}}var b=function(d,t,e,n){function s(i){return i instanceof e?i:new e(function(o){o(i)})}return new(e||(e=Promise))(function(i,o){function c(r){try{a(n.next(r))}catch(u){o(u)}}function l(r){try{a(n.throw(r))}catch(u){o(u)}}function a(r){r.done?i(r.value):s(r.value).then(c,l)}a((n=n.apply(d,t||[])).next())})};class k{constructor(){}setAddReply(t){this.addReply=t}setCurrentUser(t){this.currentUser=t}showElement(t){var e;let n=t.querySelector(".reply-container");if(!n){n=document.createElement("div"),n.classList.add("reply-container");let s=document.createElement("textarea");s.classList.add("main__input-area","reply-input"),s.placeholder="Введите ваш ответ...";let i=document.createElement("button");i.classList.add("send-reply-button"),i.textContent="";const o=((e=t.querySelector(".parent-name"))===null||e===void 0?void 0:e.textContent)||"Anonymous";i.addEventListener("click",()=>b(this,void 0,void 0,function*(){if(console.log("⏳ Перед вызовом replyComment"),console.log("ℹ️ Проверяем this.addReply:",this.addReply),!this.addReply){console.error("❌ Ошибка: this.addReply не определен!");return}yield this.addReply.replyComment(t,s.value,o,this.currentUser),console.log("Ответ добавлен"),n.remove()})),n.appendChild(s),n.appendChild(i),t.appendChild(n);const c=l=>{n.contains(l.target)||(n.remove(),document.removeEventListener("click",c))};setTimeout(()=>{document.addEventListener("click",c)},1e3)}}}class B{constructor(t,e){this.rating=0,this.currentUserId=e,this.commentId=t.dataset.commentId||`${Date.now()}`,this.ratingScore=t.querySelector(".rating-score"),this.dislikeButton=t.querySelector(".dislike-btn"),this.likeButton=t.querySelector(".like-btn"),this.favoriteButton=t.querySelector(".favorite-btn"),this.favoriteText=t.querySelector(".favorite-text"),this.favoriteIcon=t.querySelector(".favorite-icon"),this.init()}init(){this.loadRating(),this.setupRating(),this.setupFavorite()}loadRating(){const e=JSON.parse(localStorage.getItem("ratings")||"{}")[this.commentId]||{};this.rating=Object.values(e).reduce((n,s)=>n+s,0),this.ratingScore.textContent=this.rating.toString(),e[this.currentUserId]!==void 0&&(this.likeButton.disabled=!0,this.dislikeButton.disabled=!0,e[this.currentUserId]===1?this.likeButton.classList.add("liked"):e[this.currentUserId]===-1&&this.dislikeButton.classList.add("disliked"))}saveRating(t){const e=JSON.parse(localStorage.getItem("ratings")||"{}");e[this.commentId]=t,localStorage.setItem("ratings",JSON.stringify(e))}setupRating(){this.likeButton.addEventListener("click",()=>{const e=JSON.parse(localStorage.getItem("ratings")||"{}")[this.commentId]||{};e[this.currentUserId]===void 0&&(e[this.currentUserId]=1,this.rating=Object.values(e).reduce((n,s)=>n+s,0),this.ratingScore.textContent=this.rating.toString(),this.likeButton.disabled=!0,this.dislikeButton.disabled=!0,this.likeButton.classList.add("liked"),this.saveRating(e))}),this.dislikeButton.addEventListener("click",()=>{const e=JSON.parse(localStorage.getItem("ratings")||"{}")[this.commentId]||{};e[this.currentUserId]===void 0&&(e[this.currentUserId]=-1,this.rating=Object.values(e).reduce((n,s)=>n+s,0),this.ratingScore.textContent=this.rating.toString(),this.likeButton.disabled=!0,this.dislikeButton.disabled=!0,this.dislikeButton.classList.add("disliked"),this.saveRating(e))})}updateRating(){this.ratingScore.textContent=this.rating.toString()}setupFavorite(){this.isFavorite()?(this.favoriteText.textContent="В избранном",this.favoriteIcon.src="./assets/img/svg/favorite-filled.svg"):(this.favoriteText.textContent="В избранное",this.favoriteIcon.src="./assets/img/svg/favorite.svg"),this.favoriteButton.addEventListener("click",()=>{this.isFavorite()?(this.removeFromFavorites(),this.favoriteText.textContent="В избранное",this.favoriteIcon.src="./assets/img/svg/favorite.svg"):(this.addToFavorites(),this.favoriteText.textContent="В избранном",this.favoriteIcon.src="./assets/img/svg/favorite-filled.svg")})}addToFavorites(){const t=JSON.parse(localStorage.getItem("favorites")||"[]");t.includes(this.commentId)||(t.push(this.commentId),localStorage.setItem("favorites",JSON.stringify(t)))}isFavorite(){return JSON.parse(localStorage.getItem("favorites")||"[]").includes(this.commentId)}removeFromFavorites(){let t=JSON.parse(localStorage.getItem("favorites")||"[]");t=t.filter(e=>e!==this.commentId),localStorage.setItem("favorites",JSON.stringify(t))}}class m{constructor(t){this.showReplyInput=t}createComment(t,e,n,s=!0,i,o,c){const l=document.createElement("div"),a=i||`${e==null?void 0:e.name.first}-${Date.now()}`,r=new Date,u=r.toLocaleDateString("ru-RU",{day:"2-digit",month:"2-digit"}),h=r.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}),y=`${u} ${h}`,p=r.toISOString();l.dataset.timestamp=p,l.dataset.rating="0",l.classList.add("main__comment"),l.dataset.commentId=a,o&&(l.dataset.parentId=o),l.innerHTML=` 
         <div class="all-comments">
            <img src="${e==null?void 0:e.picture.medium}" class="comment-avatar main__user-avatar" alt="user-avatar"/>
          
                <div class="name-container">
                  <span class="user-name parent-name">${e==null?void 0:e.name.first} ${e==null?void 0:e.name.last}</span>
                  ${n?`<div class="reply-wrap"><img src="./assets/img/svg/reply.svg" alt="reply svg"><span class="parent-user-name">${n}</span></div>`:""}
                  <span class="comment-time">${y}</span>
                </div>
               <p class="comment-text">${t}</p> 
               <div class="main__btn-group">
                  <button class="reply-button">
                  <img src="./assets/img/svg/reply.svg" alt="reply svg">
                  <span>Ответить</span>
                  </button>
                   <div class="favorite-container">
                      <button class="favorite-btn">
                          <img src="./assets/img/svg/favorite.svg" alt="" class="favorite-icon">
                     </button>
                     <span class="favorite-text">В избранное</span>
                  </div>
                  <div class="rating-container">
                  <button class="dislike-btn">&#8722</button>
                  <span class="rating-score">0</span>
                  <button class="like-btn">+</button>
               </div>
               </div>
            
         </div>
         `,new B(l,c);const f=l.querySelector(".reply-button");return o?f.remove():f.addEventListener("click",()=>this.showReplyInput.showElement(l)),s&&this.saveCommentData({id:a,text:t,user:e,parentId:o,parentUserName:n,timestamp:p}),l}saveCommentData(t){const e=JSON.parse(localStorage.getItem("comments")||"[]");e.push(t),localStorage.setItem("comments",JSON.stringify(e))}static loadComments(t,e){const n=JSON.parse(localStorage.getItem("comments")||"[]"),s=new Map;n.forEach(o=>{const c=new m(t).createComment(o.text,o.user,o.parentUserName,!1,o.id,o.parentId,e);s.set(o.id,c)});const i=[];return s.forEach(o=>{const c=o.dataset.parentId;if(c&&s.has(c)){const l=s.get(c);let a=l.querySelector(".repliesContainer");a||(a=document.createElement("div"),a.classList.add("repliesContainer"),l.appendChild(a)),a.appendChild(o)}else i.push(o)}),i}}class R{constructor(t,e,n,s,i=1e3){this.textArea=document.getElementById(t),this.counterDisplay=document.getElementById(e),this.warningText=document.getElementById(n),this.submitButton=document.getElementById(s),this.maxLength=i,this.init()}init(){this.textArea.addEventListener("input",this.adjustHeight.bind(this)),this.textArea.addEventListener("input",()=>this.updateCounter()),this.updateCounter()}adjustHeight(){this.textArea.style.height="auto",this.textArea.style.height=this.textArea.scrollHeight+"px"}updateCounter(){let t=this.textArea.value.trim().length;this.counterDisplay.textContent=`${t}/${this.maxLength}`,t>this.maxLength?(this.warningText.textContent="Слишком длинное сообщение",this.warningText.style.color="red",this.counterDisplay.style.color="red",this.submitButton.disabled=!0):t===0?(this.warningText.textContent="",this.counterDisplay.style.color="",this.submitButton.disabled=!0):(this.warningText.textContent="",this.counterDisplay.style.color="",this.submitButton.disabled=!1)}resetCounter(){this.textArea.value="",this.textArea.style.height="auto",this.updateCounter()}}class _{constructor(t){const e=document.querySelector(t);if(!e)throw new Error(`Не удается найти элемент по селектору: ${t}`);this.commentList=e}sort(t){const e=Array.from(this.commentList.children);e.sort((n,s)=>{var i,o,c,l;switch(t){case"date":{const a=new Date(n.dataset.timestamp).getTime();return new Date(s.dataset.timestamp).getTime()-a}case"ratings":{const a=parseInt(((i=n.querySelector(".rating-score"))===null||i===void 0?void 0:i.textContent)||"0",10);return parseInt(((o=s.querySelector(".rating-score"))===null||o===void 0?void 0:o.textContent)||"0",10)-a}case"replies":{const a=n.querySelector(".repliesContainer")?n.querySelector(".repliesContainer").children.length:0;return(s.querySelector(".repliesContainer")?s.querySelector(".repliesContainer").children.length:0)-a}case"relevance":{const a=parseInt(((c=n.querySelector(".rating-score"))===null||c===void 0?void 0:c.textContent)||"0",10),r=parseInt(((l=s.querySelector(".rating-score"))===null||l===void 0?void 0:l.textContent)||"0",10),u=n.querySelector(".repliesContainer")?n.querySelector(".repliesContainer").children.length:0,h=s.querySelector(".repliesContainer")?s.querySelector(".repliesContainer").children.length:0;return r+h-(a+u)}default:return 0}}),this.commentList.innerHTML="",e.forEach(n=>{this.commentList.appendChild(n)})}}var v=function(d,t,e,n){function s(i){return i instanceof e?i:new e(function(o){o(i)})}return new(e||(e=Promise))(function(i,o){function c(r){try{a(n.next(r))}catch(u){o(u)}}function l(r){try{a(n.throw(r))}catch(u){o(u)}}function a(r){r.done?i(r.value):s(r.value).then(c,l)}a((n=n.apply(d,t||[])).next())})};class O{constructor(){this.currentUser=null,this.userService=new g,this.commentCounter=new S,this.showReplyInput=new k,this.commentElement=new m(this.showReplyInput),this.addReply=new L(this.commentCounter,this.commentElement),this.addComment=new I(this.commentCounter,this.commentElement),this.showReplyInput.setAddReply(this.addReply),this.filterComment=new _("#comment-list"),this.characterCounter=new R("comment-input","count-symbol","warning-message","submit-button",1e3),this.userAvatar=document.getElementById("user-avatar"),this.userName=document.getElementById("user-name"),this.commentInput=document.getElementById("comment-input"),this.submitButton=document.getElementById("submit-button"),this.commentList=document.getElementById("comment-list"),this.init()}init(){return v(this,void 0,void 0,function*(){if(yield this.loadRandomUser(),this.commentList.innerHTML="",!this.currentUser){console.log("Текущий пользователь не загружен");return}m.loadComments(this.showReplyInput,this.currentUser.login.uuid).forEach(n=>{this.commentList.appendChild(n)}),this.commentCounter.loadCount(),this.submitButton.addEventListener("click",()=>{this.addComment.addElem(this.commentInput,this.commentList,this.currentUser,()=>this.loadRandomUser()),this.characterCounter.resetCounter()});const e=document.getElementById("main__comments-dropdown");e&&e.addEventListener("sortOptionSelected",n=>{const i=n.detail.criteria;this.filterComment.sort(i)})})}loadRandomUser(){return v(this,void 0,void 0,function*(){try{this.currentUser=yield this.userService.getUser(),this.userAvatar.src=this.currentUser.picture.medium,this.userName.textContent=`${this.currentUser.name.first} ${this.currentUser.name.last}`,this.showReplyInput.setCurrentUser(this.currentUser)}catch{this.userName.textContent="Ошибка загрузки пользователя"}})}}class q{constructor(){this.dropdown=document.getElementById("main__comments-dropdown"),this.selected=this.dropdown.querySelector(".main__selected-option"),this.arrow=this.selected.querySelector(".arrow"),this.optionsContainer=this.dropdown.querySelector(".main__options"),this.options=this.optionsContainer.querySelectorAll(".main__option-wrap"),this.setDefaultOption(),this.initArrow()}initArrow(){this.selected.addEventListener("click",()=>this.toggleDropdown()),this.optionsContainer.addEventListener("click",t=>this.handleOptionClick(t)),document.addEventListener("click",t=>this.handleOutsideClick(t))}setDefaultOption(){const t=this.optionsContainer.querySelector(".selected-option");t&&this.updateSelectedText(t.textContent)}toggleDropdown(){const t=this.dropdown.classList.toggle("open");this.arrow.style.transform=t?"rotate(180deg)":"rotate(0deg)"}closeDropdown(){this.dropdown.classList.remove("open"),this.arrow.style.transform="rotate(0deg)"}handleOptionClick(t){const n=t.target.closest(".main__option-wrap");if(n){const s=n.querySelector("span");this.selectOption(s)}}handleOutsideClick(t){this.dropdown.contains(t.target)||this.closeDropdown()}selectOption(t){this.options.forEach(o=>{o.querySelector("span").classList.remove("selected-option")}),t.classList.add("selected-option"),this.optionsContainer.querySelectorAll(".checkmark").forEach(o=>o.classList.remove("visible"));let n=t.getAttribute("data-index");if(n){let o=this.optionsContainer.querySelector(`.checkmark[data-index="${n}"]`);o&&o.classList.add("visible")}this.updateSelectedText(t.textContent),this.closeDropdown();const s=this.indexToCriteria(n),i=new CustomEvent("sortOptionSelected",{detail:{criteria:s}});this.dropdown.dispatchEvent(i)}indexToCriteria(t){switch(t){case"0":return"ratings";case"1":return"date";case"2":return"relevance";case"3":return"replies";default:return"date"}}updateSelectedText(t){const e=this.selected.querySelector("span");e&&t&&(e.textContent=t)}}document.addEventListener("DOMContentLoaded",()=>{console.log("DOMContentLoaded"),new O,new q});
